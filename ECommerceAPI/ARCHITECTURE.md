# Architecture Overview

## System Architecture Diagram

```
???????????????????????????????????????????????????????????????????
?                         CLIENT REQUEST                           ?
?                    (with X-Correlation-ID)                       ?
???????????????????????????????????????????????????????????????????
                             ?
                             ?
???????????????????????????????????????????????????????????????????
?                   CORRELATION ID MIDDLEWARE                      ?
?  • Extract or Generate Correlation ID                           ?
?  • Add to Response Headers                                      ?
?  • Store in HttpContext                                         ?
?  • Log Request with ID                                          ?
???????????????????????????????????????????????????????????????????
                             ?
                             ?
???????????????????????????????????????????????????????????????????
?                     PRODUCTS CONTROLLER                          ?
?  ?????????????????????????????????????????????????????????????  ?
?  ?  POST /api/products    ?  GET /api/products/{id}         ?  ?
?  ?  • Validate Input      ?  • Get Correlation ID           ?  ?
?  ?  • Save to DB          ?  • Fetch from DB                ?  ?
?  ?  • Return Product      ?  • Call Inventory Service       ?  ?
?  ?????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????
            ?                             ?
            ?                             ?
?????????????????????????????  ????????????????????????????????????
?  APPLICATION DB CONTEXT   ?  ?     INVENTORY SERVICE            ?
?  (Entity Framework Core)  ?  ?  • HttpClient via Factory        ?
?                          ?  ?  • Add Correlation ID to Header  ?
?  ??????????????????????? ?  ?  • Call External API             ?
?  ?  Products Table     ? ?  ?  • Handle Failures Gracefully    ?
?  ?  • Id              ? ?  ?  • Return null on Error          ?
?  ?  • Name            ? ?  ?  • Log with Correlation ID       ?
?  ?  • Description     ? ?  ????????????????????????????????????
?  ??????????????????????? ?               ?
?????????????????????????????               ?
            ?                               ?
            ?                               ?
?????????????????????????????  ????????????????????????????????????
?      SQL SERVER           ?  ?  EXTERNAL INVENTORY API          ?
?    (LocalDB / Full)       ?  ?  (Mock: InventoryController)     ?
?                          ?  ?                                  ?
?  • ECommerceDB           ?  ?  GET /api/inventory/{id}         ?
?  • Products table        ?  ?  • Receives Correlation ID        ?
?  • Auto-created in Dev   ?  ?  • Returns Price & Stock         ?
?????????????????????????????  ?  • Logs Request                  ?
                               ????????????????????????????????????
                                             ?
                                             ?
                               ????????????????????????????????????
                               ?    INVENTORY DATA RETURNED        ?
                               ?    • Price: decimal              ?
                               ?    • Stock: int                  ?
                               ????????????????????????????????????
```

## Request Flow - GET /api/products/{id}

```
1. Client sends request with optional X-Correlation-ID
   ?
2. CorrelationIdMiddleware
   • Extracts or generates ID
   • Logs: "Incoming request with Correlation-ID: xxx"
   • Stores in HttpContext.Items["CorrelationId"]
   ?
3. ProductsController.GetProduct()
   • Extracts correlation ID from HttpContext
   • Queries database for product
   ?
4. If product found:
   ??? IInventoryService.GetInventoryDataAsync()
   ?   • HttpClient adds X-Correlation-ID header
   ?   • Logs: "Fetching inventory data with Correlation-ID: xxx"
   ?   • Calls GET /api/inventory/{id}
   ?   ?
   ?   • External API (mock) receives request
   ?   • Logs: "Mock Inventory API - Request with Correlation-ID: xxx"
   ?   • Returns Price & Stock
   ?   ?
   ?   • InventoryService receives response
   ?   • Logs: "Successfully retrieved inventory data with Correlation-ID: xxx"
   ?   • Returns InventoryData or null
   ?
   ??? Controller merges data:
       • Local: Id, Name, Description
       • External: Price, Stock
       • Status: "Live" or "Data Unavailable"
       ?
5. Returns ProductResponse to client
   ?
6. CorrelationIdMiddleware
   • Adds X-Correlation-ID to response headers
   • Logs: "Outgoing response: 200 with Correlation-ID: xxx"
   ?
7. Client receives complete product data
```

## Request Flow - POST /api/products

```
1. Client sends request with product data
   ?
2. CorrelationIdMiddleware
   • Extracts or generates ID
   • Logs incoming request
   ?
3. ProductsController.CreateProduct()
   • Validates input (ModelState)
   • If invalid: Return 400 Bad Request
   ?
4. Create Product entity
   • Map from CreateProductRequest DTO
   • Add to DbContext
   • SaveChangesAsync()
   ?
5. Product saved to database
   • SQL Server generates Id
   ?
6. Return ProductResponse
   • 201 Created
   • Location header: /api/products/{id}
   • DataStatus: "Local data only"
   • NOTE: Does NOT call external API
   ?
7. CorrelationIdMiddleware
   • Adds X-Correlation-ID to response
   • Logs outgoing response
   ?
8. Client receives created product
```

## Data Flow

```
????????????????????????
?   CreateProductRequest?  (Input DTO)
?   • Name             ?
?   • Description      ?
????????????????????????
          ? Validation
          ?
????????????????????????
?   Product Entity     ?  (Domain Model)
?   • Id               ?
?   • Name             ?
?   • Description      ?
????????????????????????
          ? EF Core
          ?
????????????????????????
?   Database Table     ?  (Persistence)
?   Products           ?
????????????????????????

          ??????????????????????????
          ?  InventoryData         ?  (External DTO)
          ?  • Price               ?
          ?  • Stock               ?
          ??????????????????????????
                      ? Merge
                      ?
????????????????????????????????????
?   ProductResponse                ?  (Output DTO)
?   • Id                          ?
?   • Name                        ?
?   • Description                 ?
?   • Price (nullable)            ?
?   • Stock (nullable)            ?
?   • DataStatus                  ?
????????????????????????????????????
```

## Component Dependencies

```
Program.cs
  ??? Registers Services
  ?   ??? DbContext ? ApplicationDbContext
  ?   ??? HttpClient ? IInventoryService ? InventoryService
  ?   ??? Controllers ? ProductsController
  ?
  ??? Configures Middleware Pipeline
  ?   ??? UseCorrelationId() ? CorrelationIdMiddleware
  ?   ??? UseHttpsRedirection()
  ?   ??? UseAuthorization()
  ?   ??? MapControllers()
  ?
  ??? Database Initialization (Dev mode)
      ??? DbContext.EnsureCreated()

ProductsController
  ??? Depends on: ApplicationDbContext
  ??? Depends on: IInventoryService
  ??? Depends on: ILogger<ProductsController>

InventoryService
  ??? Depends on: HttpClient (injected by factory)
  ??? Depends on: ILogger<InventoryService>

CorrelationIdMiddleware
  ??? Depends on: RequestDelegate (pipeline)
  ??? Depends on: ILogger<CorrelationIdMiddleware>
```

## Error Handling Flow

```
External API Call Fails
  ?
  ??? HttpRequestException caught
  ?   • Log error with correlation ID
  ?   • Return null
  ?
  ??? Timeout
  ?   • Log warning
  ?   • Return null
  ?
  ??? Any Exception
      • Log error
      • Return null

Controller receives null inventory data
  ?
  ??? Product exists
  ?   • Return product with local data
  ?   • Price: null
  ?   • Stock: null
  ?   • DataStatus: "Data Unavailable"
  ?   • HTTP 200 OK
  ?
  ??? Product doesn't exist
      • Return HTTP 404 Not Found
```

## Correlation ID Flow

```
Request arrives
  ?
Middleware checks for X-Correlation-ID header
  ?
???????????????????
? Header exists?  ?
???????????????????
     ?       ?
    YES     NO
     ?       ?
     ?       ??? Generate new GUID
     ?           ?
     ??????????????? Store in HttpContext.Items["CorrelationId"]
                     ?
                     ??? Add to response headers
                     ?
                     ??? Log: "Incoming request with ID: xxx"
                     ?
                     ??? Controller extracts from HttpContext
                     ?
                     ??? Pass to InventoryService
                     ?
                     ??? InventoryService adds to HttpClient header
                     ?
                     ??? External API receives same ID
                     ?
                     ??? Logs include ID at every step
                     ?
                     ??? Response includes ID in header
```

## Resilience Strategy

```
???????????????????????????????????????????????????????????????
?                    RESILIENCE PATTERN                        ?
???????????????????????????????????????????????????????????????
?                                                             ?
?  Try to fetch external data                                ?
?    ?                                                        ?
?    ??? Success: Return merged data                         ?
?    ?   • Local + External                                  ?
?    ?   • DataStatus: "Live"                                ?
?    ?   • HTTP 200 OK                                       ?
?    ?                                                        ?
?    ??? Failure: Return local data only                     ?
?        • Local data only                                   ?
?        • DataStatus: "Data Unavailable"                    ?
?        • HTTP 200 OK (not error!)                          ?
?        • Log warning                                       ?
?                                                             ?
?  Key Principle: NEVER FAIL COMPLETELY                      ?
?  Always return something useful to the client              ?
?                                                             ?
???????????????????????????????????????????????????????????????
```

## Technology Stack Integration

```
????????????????????????????????????????????????????????????????
?                         .NET 10                              ?
????????????????????????????????????????????????????????????????
?                                                              ?
?  ASP.NET Core Web API                                       ?
?    ??? Controllers                                          ?
?    ??? Middleware Pipeline                                  ?
?    ??? Dependency Injection                                 ?
?    ??? Configuration System                                 ?
?                                                              ?
?  Entity Framework Core 10                                   ?
?    ??? DbContext                                            ?
?    ??? Code-First Approach                                  ?
?    ??? SQL Server Provider                                  ?
?    ??? Connection Resilience                                ?
?                                                              ?
?  HttpClientFactory                                          ?
?    ??? Typed Client Pattern                                ?
?    ??? Proper Socket Management                            ?
?    ??? Centralized Configuration                           ?
?    ??? Testability                                          ?
?                                                              ?
?  Built-in Logging                                           ?
?    ??? ILogger<T>                                          ?
?    ??? Structured Logging                                   ?
?    ??? Log Levels                                           ?
?                                                              ?
????????????????????????????????????????????????????????????????
```

## Deployment Architecture

```
?????????????????????????????????????????????????????????????????
?                     DEVELOPMENT                               ?
?????????????????????????????????????????????????????????????????
?  • LocalDB (SQL Server)                                      ?
?  • EnsureCreated() for database                             ?
?  • Debug logging                                             ?
?  • Developer exception page                                  ?
?  • OpenAPI/Swagger                                          ?
?????????????????????????????????????????????????????????????????

?????????????????????????????????????????????????????????????????
?                     PRODUCTION                                ?
?????????????????????????????????????????????????????????????????
?  • SQL Server (Azure SQL or on-prem)                        ?
?  • Database migrations                                       ?
?  • Information logging                                       ?
?  • Error pages / API problem details                        ?
?  • API documentation                                         ?
?  • Health checks                                            ?
?  • Monitoring (Application Insights)                        ?
?  • Authentication & Authorization                           ?
?  • Rate limiting                                            ?
?  • Caching (Redis)                                          ?
?????????????????????????????????????????????????????????????????
```

## Summary

This architecture provides:

? **Separation of Concerns**: Clear layers with distinct responsibilities
? **Resilience**: Graceful degradation when external services fail
? **Observability**: Correlation ID tracking across all components
? **Maintainability**: Clean code structure, easy to modify
? **Scalability**: Stateless design, ready for horizontal scaling
? **Testability**: Dependency injection, interface-based abstractions
? **Production-Ready**: Error handling, logging, configuration management
